#include <stdio.h>
#include <string.h>
#include <unistd.h>

#include "Message_Def.h"
#include "Module_Def.h"
#include "util.h"


/* 90Byte */
static unsigned char mcudata_general[] = 
{
	0x00, 0x00, 0x00, 0x00,/* IPC_UART_DATA_GENERAL_UP */ 
	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0xae, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x33, 0x89, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x8c,
	0x88, 0x13, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x12, 0x4b, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x05, 0x09, 0x0f, 0x64, 0x37, 0x0d, 0x0c, 0x0c, 0x0c, 0x0c 
};

/* 103Byte */
static unsigned char mcudata_special[] = 
{
	0x00, 0x00, 0x00, 0x00,/* IPC_UART_DATA_SPECIAL_UP */ 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x2e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x06, 0x0c, 0x05, 0x00,
	0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x00, 0x00, 0x00,
	0x00
};


/* reset func */
static unsigned char reset_frame[4] = {};


#define INSERT( array, nint ) \
	do { \
		array[0] = nint & 0xff; \
		array[1] = (nint >> 8)  & 0xff; \
		array[2] = (nint >> 16) & 0xff; \
		array[3] = (nint >> 24) & 0xff; \
	}while (0)


void *send_mcudata_thread(void *args)
{
	char *type = "UnitTestModule.signal.type";
	DBusConnection *dbus;
	dbus = get_dbus("com.saic.UnitTestModule");
	if (!dbus)
	{
		printf("#########get_dbus error!!\n");
		return NULL;
	}

	int ret = 0;
	int exchange = 0; 
	int size = 0;
	unsigned char *mcudataPtr = mcudata_general;

	INSERT(mcudata_general, IPC_UART_DATA_GENERAL_UP);
	INSERT(mcudata_special, IPC_UART_DATA_SPECIAL_UP);
	INSERT(reset_frame, APP_CLUSTER_SELFCHECK_READY);

	while (1)
	{
		//if (exchange ^= 1)
		//{
		//	printf("mcudata_general\n");
		//	mcudataPtr = mcudata_general;
		//	size = sizeof(mcudata_general);
		//}
		//else
		//{
		//	printf("mcudata_special\n");
		//	mcudataPtr = mcudata_special;
		//	size = sizeof(mcudata_special);
		//}

		if (exchange == 0)
		{
			printf("mcudata_general\n");
			mcudataPtr = mcudata_general;
			size = sizeof(mcudata_general);
			exchange++;
		}
		else if (exchange == 1)
		{
			printf("mcudata_special\n");
			mcudataPtr = mcudata_special;
			size = sizeof(mcudata_special);
			exchange++;
		}
		else if (exchange == 2)
		{
			printf("reset_frame\n");
			mcudataPtr = reset_frame;
			size = sizeof(reset_frame);
			exchange = 0;
		}

		ret = dbus_send(dbus,
				mcudataPtr,
				size, 			   /* size */
				MODULE_SERVICE_DI_DATA_ANALISIS_PATH,  /* path */
				type);
		if (-1 == ret)
		{
			printf("#########dbus_send error!!!\n");
		}
		printf("send success!!\n");

		usleep(200000);
	}
}

int main(int argc, char *argv[])
{
	pthread_t pth;

	if (0 != pthread_create(&pth, NULL, send_mcudata_thread, NULL))
	{
		printf("pthread create error!!!\n");	
	}
	
	printf("pthread create successfully!!\n");

	pthread_join(pth, NULL);
	return 0;
}
